const express=require("express"),app=express(),port=3e3,bodyParser=require("body-parser"),cors=require("cors"),mongoose=require("mongoose"),bcrypt=require("bcryptjs"),fs=require("fs"),multer=require("multer"),config=require("./config.json"),Users=require("./models/users"),Listings=require("./models/listings"),Comments=require("./models/comments");mongoose.connect(`mongodb+srv://${config.MONGO_USERNAME}:${config.MONGO_PASSWORD}@${config.CLUSTER_NAME}.mongodb.net/${config.TABLE_NAME}?retryWrites=true&w=majority`,{useNewUrlParser:!0,useUnifiedTopology:!0});const db=mongoose.connection;db.on("error",console.error.bind(console,"connection error:")),db.once("open",()=>{console.log("we are connected mongo db")});const storage=multer.diskStorage({destination:(e,n,s)=>{s(null,"./uploads")},filename:(e,n,s)=>{s(null,`${Date.now()}-${n.originalname}`)}}),filterFile=(e,n,s)=>{"image/jpeg"===n.mimetype||"image/png"===n.mimetype?s(null,!0):(e.validationError="invalid extension",s(null,!1,e.validationError))},upload=multer({storage:storage,fileFilter:filterFile});app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!1})),app.use(cors()),app.use("/uploads",express.static("uploads")),app.use((e,n,s)=>{console.log(`${e.method} request for ${e.url}`),s()}),app.get("/",(e,n)=>{n.send("Welcome to our Pop Culture Merchandise Niche Market App")}),app.post("/registerUser",(e,n)=>{const s=bcrypt.hashSync(e.body.password);new Users({_id:new mongoose.Types.ObjectId,name:e.body.name,address:e.body.address,username:e.body.username,password:s,email:e.body.email,dob:e.body.dob,registerDate:e.body.registerDate}).save().then(e=>{n.send(e)}).catch(e=>{n.send(e)})}),app.post("/newListing",upload.single("filePath"),(e,n)=>{new Listings({_id:new mongoose.Types.ObjectId,title:e.body.title,description:e.body.description,price:e.body.price,filePath:e.file.path,originalName:e.body.originalName,uploaderId:e.body.userId}).save().then(e=>{n.send(e)}).catch(e=>{n.send(e)})}),app.post("/addAComment",(e,n)=>{let s=JSON.parse(e.body.data);new Comments({_id:new mongoose.Types.ObjectId,listingId:s.listingId,commentUsername:s.commentUsername,commentText:s.commentText,commentDate:s.commentDate,commentUserId:s.commentUserId,commentReply:{reply:s.reply,replyUsername:s.replyUsername,replyText:s.replyText,replyDate:s.replyDate,replyUserId:s.replyUserId}}).save().then(e=>{n.send(e)}).catch(e=>{n.send(e)})}),app.get("/home",(e,n)=>{Listings.find().then(e=>{let s=[];s.push(e[Math.floor(Math.random()*e.length)]);let o=8;e.map((e,n)=>{n<o&&(e.bought?o++:s.push(e))}),n.send(s)}).catch(e=>{console.log(e),n.send(e)})}),app.post("/login",(e,n)=>{Users.findOne({username:e.body.username},(s,o)=>{o?bcrypt.compareSync(e.body.password,o.password)?n.send(o):n.send("Invalid Password"):n.send("Invalid Username")})}),app.get("/allListings",(e,n)=>{Listings.find().then(e=>{n.send(e)})}),app.post("/product",(e,n)=>{let s={};Listings.findById(e.body.id,(o,t)=>{Users.findById(t.uploaderId,(o,d)=>{s.uploaderName=d.username,Comments.find().then(o=>{if(o.length>0){let n=[];o.map(s=>{s.listingId==e.body.id&&n.push(s)}),n.length>0?s.comments=n:s.comments="No comments found"}else s.comments="No comments found";s.info=t,n.send(s)})}).catch(e=>{n.send("Can not find the user who uploaded this listing")})}).catch(e=>{n.send("Can not find that item")})}),app.patch("/updateListing",(e,n)=>{const s=e.body.id;Listings.findById(s,(o,t)=>{if(t.uploaderId==e.body.userId){const o={title:e.body.title,description:e.body.description,price:e.body.price};Listings.updateOne({_id:s},o).then(e=>{n.send(e)}).catch(e=>{n.send(e)})}else n.send("401")}).catch(e=>{n.send("cannot find listing with that id")})}),app.patch("/buyListing",(e,n)=>{const s=e.body.id;Listings.findById(s,(o,t)=>{if(t.uplaoderId!=e.body.userId){const e={bought:!0};Listings.updateOne({_id:s},e).then(e=>{n.send(e)}).catch(e=>{n.send(e)})}else n.send("invalid")}).catch(e=>{n.send(e)})}),app.patch("/addReply",(e,n)=>{let s=JSON.parse(e.body.data);const o=s.commentId;Comments.findById(o,(e,t)=>{const d={commentReply:{reply:!0,replyUsername:s.replyUsername,replyText:s.replyText,replyDate:s.replyDate,replyUserId:s.replyUserId}};Comments.updateOne({_id:o},d).then(e=>{n.send(e)}).catch(e=>n.send(e))}).catch(e=>{n.send("cannot find comment with that id")})}),app.delete("/deleteListing",(e,n)=>{const s=e.body.id;Listings.findById(s,(o,t)=>{t?e.body.userId==t.uploaderId?fs.unlink(`./${t.filePath.replace(/\\/g,"/")}`,o=>{o?n.send(o):(Listings.deleteOne({_id:e.body.id},e=>{e?n.send(e):n.send("deleted")}),Comments.deleteMany({listingId:s},e=>{e?console.log("Comments failed to delete"):console.log("All comments were deleted")}))}):n.send("Permission denied"):n.send("No listing found")})}),app.delete("/deleteComment",(e,n)=>{const s=e.body.commentId;Comments.findById(s,(o,t)=>{t?t.listingId==e.body.listingId&&t.commentUserId==e.body.userId?Comments.deleteOne({id:s},e=>{e?n.send("Failed to delete comment"):n.send("Comment deleted")}):n.send("You dont have permission to delete this comment"):n.send("No comment found")})}),app.listen(3e3,()=>{console.log("application is running on port 3000")});